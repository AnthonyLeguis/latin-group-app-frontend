<div class="modal-container">
    <!-- Loading State -->
    <div *ngIf="loading" class="loading-container">
        <app-form-skeleton></app-form-skeleton>
    </div>

    <!-- Error State -->
    <div *ngIf="!loading && error && !form" class="error-container">
        <mat-icon class="error-icon">error_outline</mat-icon>
        <h3>Error al cargar la planilla</h3>
        <p>{{ error }}</p>
        <div class="error-actions">
            <button mat-flat-button color="primary" (click)="loadFormData()">
                <mat-icon>refresh</mat-icon>
                Reintentar
            </button>
            <button mat-stroked-button (click)="onClose()">
                <mat-icon>close</mat-icon>
                Cerrar
            </button>
        </div>
    </div>

    <!-- Form Content -->
    <div *ngIf="!loading && form" class="modal-content">
        <!-- Header -->
        <div class="modal-header">
            <div class="header-content">
                <mat-icon class="header-icon">description</mat-icon>
                <div>
                    <h2>Planilla #{{ form.id }}</h2>
                    <p class="header-subtitle">{{ form.applicant_name }}</p>
                </div>
            </div>
            <button mat-icon-button (click)="onClose()" class="close-button">
                <mat-icon>close</mat-icon>
            </button>
        </div>

        <!-- Status Badge -->
        <div class="status-badge" [ngClass]="form.status">
            <mat-icon>{{ currentStatus?.icon }}</mat-icon>
            <span>{{ currentStatus?.label }}</span>
        </div>

        <!-- Pending Changes Alert -->
        <div *ngIf="form.has_pending_changes" class="pending-changes-alert">
            <div class="alert-header">
                <mat-icon class="pulse-icon">warning</mat-icon>
                <div class="alert-content">
                    <h4>Cambios Pendientes de Aprobación</h4>
                    <p>El agente {{ form.agent?.name }} ha propuesto modificaciones a esta planilla activa.</p>
                    <p class="alert-date">
                        <mat-icon>schedule</mat-icon>
                        {{ formatDate(form.pending_changes_at) }}
                    </p>
                </div>
            </div>

            <!-- Acciones de aprobación/rechazo -->
            <div class="pending-actions" *ngIf="!showRejectionForm">
                <button mat-flat-button color="primary" (click)="togglePendingChangesView()" [disabled]="submitting">
                    <mat-icon>{{ viewingPendingChanges ? 'visibility_off' : 'visibility' }}</mat-icon>
                    {{ viewingPendingChanges ? 'Ocultar Cambios' : 'Ver Cambios Propuestos' }}
                </button>
                <button mat-flat-button class="approve-btn" (click)="onApprovePendingChanges()" [disabled]="submitting">
                    <mat-spinner *ngIf="submitting" diameter="20"></mat-spinner>
                    <mat-icon *ngIf="!submitting">check_circle</mat-icon>
                    Aprobar Cambios
                </button>
                <button mat-stroked-button color="warn" (click)="onShowRejectionForm()" [disabled]="submitting">
                    <mat-icon>cancel</mat-icon>
                    Rechazar
                </button>
            </div>

            <!-- Formulario de rechazo -->
            <div class="rejection-form" *ngIf="showRejectionForm">
                <form [formGroup]="rejectionForm">
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Motivo del rechazo</mat-label>
                        <textarea matInput formControlName="rejection_reason" rows="4"
                            placeholder="Explica por qué rechazas estos cambios..." maxlength="500"></textarea>
                        <mat-hint align="end">{{ rejectionForm.get('rejection_reason')?.value?.length || 0
                            }}/500</mat-hint>
                        <mat-error *ngIf="rejectionForm.get('rejection_reason')?.hasError('required')">
                            El motivo es requerido
                        </mat-error>
                        <mat-error *ngIf="rejectionForm.get('rejection_reason')?.hasError('minlength')">
                            Mínimo 10 caracteres
                        </mat-error>
                    </mat-form-field>
                    <div class="rejection-actions">
                        <button mat-flat-button color="warn" (click)="onRejectPendingChanges()"
                            [disabled]="rejectionForm.invalid || submitting">
                            <mat-spinner *ngIf="submitting" diameter="20"></mat-spinner>
                            <mat-icon *ngIf="!submitting">send</mat-icon>
                            Confirmar Rechazo
                        </button>
                        <button mat-stroked-button (click)="onCancelRejection()" [disabled]="submitting">
                            <mat-icon>close</mat-icon>
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Form Details -->
        <div class="details-section">
            <h3>
                <mat-icon>person</mat-icon>
                Información del Aplicante
            </h3>

            <div class="details-grid">
                <div class="detail-item"
                    [class.has-changes]="viewingPendingChanges && hasPendingChange('applicant_name')">
                    <label>Nombre Completo</label>
                    <span *ngIf="!viewingPendingChanges || !hasPendingChange('applicant_name')">{{ form.applicant_name
                        }}</span>
                    <div *ngIf="viewingPendingChanges && hasPendingChange('applicant_name')" class="value-comparison">
                        <div class="old-value">
                            <span class="label-small">Actual:</span>
                            <span>{{ form.applicant_name }}</span>
                        </div>
                        <mat-icon class="arrow-icon">arrow_forward</mat-icon>
                        <div class="new-value">
                            <span class="label-small">Propuesto:</span>
                            <span>{{ getPendingValue('applicant_name') }}</span>
                        </div>
                    </div>
                </div>

                <div class="detail-item" [class.has-changes]="viewingPendingChanges && hasPendingChange('dob')">
                    <label>Fecha de Nacimiento</label>
                    <span *ngIf="!viewingPendingChanges || !hasPendingChange('dob')">{{ formatDate(form.dob) }}</span>
                    <div *ngIf="viewingPendingChanges && hasPendingChange('dob')" class="value-comparison">
                        <div class="old-value">
                            <span class="label-small">Actual:</span>
                            <span>{{ formatDate(form.dob) }}</span>
                        </div>
                        <mat-icon class="arrow-icon">arrow_forward</mat-icon>
                        <div class="new-value">
                            <span class="label-small">Propuesto:</span>
                            <span>{{ formatDate(getPendingValue('dob')) }}</span>
                        </div>
                    </div>
                </div>

                <div class="detail-item" [class.has-changes]="viewingPendingChanges && hasPendingChange('gender')">
                    <label>Género</label>
                    <span *ngIf="!viewingPendingChanges || !hasPendingChange('gender')">{{ form.gender }}</span>
                    <div *ngIf="viewingPendingChanges && hasPendingChange('gender')" class="value-comparison">
                        <div class="old-value">
                            <span class="label-small">Actual:</span>
                            <span>{{ form.gender }}</span>
                        </div>
                        <mat-icon class="arrow-icon">arrow_forward</mat-icon>
                        <div class="new-value">
                            <span class="label-small">Propuesto:</span>
                            <span>{{ getPendingValue('gender') }}</span>
                        </div>
                    </div>
                </div>

                <div class="detail-item" [class.has-changes]="viewingPendingChanges && hasPendingChange('ssn')">
                    <label>SSN</label>
                    <span *ngIf="!viewingPendingChanges || !hasPendingChange('ssn')">{{ form.ssn || 'N/A' }}</span>
                    <div *ngIf="viewingPendingChanges && hasPendingChange('ssn')" class="value-comparison">
                        <div class="old-value">
                            <span class="label-small">Actual:</span>
                            <span>{{ form.ssn || 'N/A' }}</span>
                        </div>
                        <mat-icon class="arrow-icon">arrow_forward</mat-icon>
                        <div class="new-value">
                            <span class="label-small">Propuesto:</span>
                            <span>{{ getPendingValue('ssn') || 'N/A' }}</span>
                        </div>
                    </div>
                </div>

                <div class="detail-item" [class.has-changes]="viewingPendingChanges && hasPendingChange('email')">
                    <label>Email</label>
                    <span *ngIf="!viewingPendingChanges || !hasPendingChange('email')">{{ form.email }}</span>
                    <div *ngIf="viewingPendingChanges && hasPendingChange('email')" class="value-comparison">
                        <div class="old-value">
                            <span class="label-small">Actual:</span>
                            <span>{{ form.email }}</span>
                        </div>
                        <mat-icon class="arrow-icon">arrow_forward</mat-icon>
                        <div class="new-value">
                            <span class="label-small">Propuesto:</span>
                            <span>{{ getPendingValue('email') }}</span>
                        </div>
                    </div>
                </div>

                <div class="detail-item" [class.has-changes]="viewingPendingChanges && hasPendingChange('phone')">
                    <label>Teléfono</label>
                    <span *ngIf="!viewingPendingChanges || !hasPendingChange('phone')">{{ form.phone }}</span>
                    <div *ngIf="viewingPendingChanges && hasPendingChange('phone')" class="value-comparison">
                        <div class="old-value">
                            <span class="label-small">Actual:</span>
                            <span>{{ form.phone }}</span>
                        </div>
                        <mat-icon class="arrow-icon">arrow_forward</mat-icon>
                        <div class="new-value">
                            <span class="label-small">Propuesto:</span>
                            <span>{{ getPendingValue('phone') }}</span>
                        </div>
                    </div>
                </div>

                <div class="detail-item full-width"
                    [class.has-changes]="viewingPendingChanges && (hasPendingChange('address') || hasPendingChange('city') || hasPendingChange('state') || hasPendingChange('zip_code'))">
                    <label>Dirección</label>
                    <span
                        *ngIf="!viewingPendingChanges || !(hasPendingChange('address') || hasPendingChange('city') || hasPendingChange('state') || hasPendingChange('zip_code'))">
                        {{ form.address }}, {{ form.city }}, {{ form.state }} {{ form.zip_code }}
                    </span>
                    <div *ngIf="viewingPendingChanges && (hasPendingChange('address') || hasPendingChange('city') || hasPendingChange('state') || hasPendingChange('zip_code'))"
                        class="value-comparison">
                        <div class="old-value">
                            <span class="label-small">Actual:</span>
                            <span>{{ form.address }}, {{ form.city }}, {{ form.state }} {{ form.zip_code }}</span>
                        </div>
                        <mat-icon class="arrow-icon">arrow_forward</mat-icon>
                        <div class="new-value">
                            <span class="label-small">Propuesto:</span>
                            <span>
                                {{ getPendingValue('address') || form.address }},
                                {{ getPendingValue('city') || form.city }},
                                {{ getPendingValue('state') || form.state }}
                                {{ getPendingValue('zip_code') || form.zip_code }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Insurance Information -->
        <div class="details-section">
            <h3>
                <mat-icon>health_and_safety</mat-icon>
                Información del Seguro
            </h3>

            <div class="details-grid">
                <div class="detail-item">
                    <label>Compañía</label>
                    <span>{{ form.insurance_company }}</span>
                </div>

                <div class="detail-item">
                    <label>Plan</label>
                    <span>{{ form.insurance_plan }}</span>
                </div>

                <div class="detail-item">
                    <label>Subsidio</label>
                    <span>{{ formatCurrency(form.subsidy) }}</span>
                </div>

                <div class="detail-item">
                    <label>Costo Final</label>
                    <span class="highlight">{{ formatCurrency(form.final_cost) }}</span>
                </div>
            </div>
        </div>

        <!-- Policy Information (if exists) -->
        <div class="details-section" *ngIf="form.poliza_number">
            <h3>
                <mat-icon>policy</mat-icon>
                Información de Póliza
            </h3>

            <div class="details-grid">
                <div class="detail-item">
                    <label>Número de Póliza</label>
                    <span>{{ form.poliza_number }}</span>
                </div>

                <div class="detail-item">
                    <label>Categoría</label>
                    <span>{{ form.poliza_category || 'N/A' }}</span>
                </div>

                <div class="detail-item">
                    <label>Monto</label>
                    <span>{{ formatCurrency(form.poliza_amount) }}</span>
                </div>

                <div class="detail-item">
                    <label>Beneficiario</label>
                    <span>{{ form.poliza_beneficiary || 'N/A' }}</span>
                </div>
            </div>
        </div>

        <!-- Agent Information -->
        <div class="details-section">
            <h3>
                <mat-icon>support_agent</mat-icon>
                Agente Asignado
            </h3>

            <div class="agent-info">
                <mat-icon class="agent-avatar">account_circle</mat-icon>
                <div>
                    <p class="agent-name">{{ form.agent?.name || form.agent_name }}</p>
                    <p class="agent-email">{{ form.agent?.email }}</p>
                </div>
            </div>
        </div>

        <!-- Status Update Form -->
        <div class="status-update-section">
            <h3>
                <mat-icon>edit_note</mat-icon>
                Actualizar Estado
            </h3>

            <form [formGroup]="statusForm" (ngSubmit)="onSubmit()">
                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Nuevo Estado</mat-label>
                    <mat-select formControlName="status">
                        <mat-select-trigger>
                            <div class="status-option" *ngIf="currentStatus">
                                <mat-icon [style.color]="currentStatus.color">{{ currentStatus.icon }}</mat-icon>
                                <span>{{ currentStatus.label }}</span>
                            </div>
                        </mat-select-trigger>
                        <mat-option *ngFor="let status of statuses" [value]="status.value">
                            <div class="status-option">
                                <mat-icon [style.color]="status.color">{{ status.icon }}</mat-icon>
                                <span>{{ status.label }}</span>
                            </div>
                        </mat-option>
                    </mat-select>
                    <mat-icon matPrefix>flag</mat-icon>
                    <mat-error *ngIf="statusForm.get('status')?.hasError('required')">
                        El estado es requerido
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Comentario / Motivo</mat-label>
                    <textarea matInput formControlName="status_comment" rows="4"
                        placeholder="Explica el motivo del cambio de estado..." maxlength="1000"></textarea>
                    <mat-icon matPrefix>comment</mat-icon>
                    <mat-hint align="end">
                        {{ statusForm.get('status_comment')?.value?.length || 0 }} / 1000
                    </mat-hint>
                    <mat-error *ngIf="statusForm.get('status_comment')?.hasError('required')">
                        El comentario es requerido
                    </mat-error>
                </mat-form-field>

                <div class="form-actions">
                    <button mat-stroked-button type="button" (click)="onClose()" [disabled]="submitting">
                        <mat-icon>close</mat-icon>
                        Cancelar
                    </button>

                    <button mat-flat-button color="primary" type="submit" [disabled]="statusForm.invalid || submitting">
                        <mat-icon *ngIf="!submitting">save</mat-icon>
                        <mat-spinner *ngIf="submitting" diameter="20"></mat-spinner>
                        {{ submitting ? 'Guardando...' : 'Actualizar Estado' }}
                    </button>
                </div>
            </form>
        </div>

        <!-- Status History (if available) -->
        <div class="history-section" *ngIf="form.status_comment">
            <h3>
                <mat-icon>history</mat-icon>
                Último Cambio
            </h3>

            <div class="history-item">
                <p class="history-comment">{{ form.status_comment }}</p>
                <p class="history-meta" *ngIf="form.reviewed_at">
                    <mat-icon>schedule</mat-icon>
                    {{ formatDate(form.reviewed_at) }}
                </p>
            </div>
        </div>

        <!-- Metadata -->
        <div class="metadata">
            <div class="meta-item">
                <mat-icon>event</mat-icon>
                <span>Creada: {{ formatDate(form.created_at) }}</span>
            </div>
            <div class="meta-item">
                <mat-icon>update</mat-icon>
                <span>Actualizada: {{ formatDate(form.updated_at) }}</span>
            </div>
        </div>
    </div>
</div>