<div class="form-detail-modal-container">
    <!-- Loading State -->
    <div *ngIf="loading" class="loading-container">
        <app-form-skeleton></app-form-skeleton>
    </div>

    <!-- Error State -->
    <div *ngIf="!loading && error && !form" class="error-container">
        <mat-icon class="error-icon">error_outline</mat-icon>
        <h3>Error al cargar la planilla</h3>
        <p>{{ error }}</p>
        <div class="error-actions">
            <button mat-flat-button color="primary" (click)="loadFormData()">
                <mat-icon>refresh</mat-icon>
                Reintentar
            </button>
            <button mat-stroked-button (click)="onClose()">
                <mat-icon>close</mat-icon>
                Cerrar
            </button>
        </div>
    </div>

    <!-- Form Content -->
    <div *ngIf="!loading && form" class="modal-content-wrapper">
        <!-- Modal Card Container -->
        <div class="form-detail-card">
            <!-- Header Section -->
            <div class="card-header">
                <div class="header-left">
                    <mat-icon class="header-icon">description</mat-icon>
                    <div class="header-text">
                        <h2>Planilla #{{ form.id }}</h2>
                        <p class="subtitle">{{ form.applicant_name }} • {{ form.client?.name }}</p>
                    </div>
                </div>
                <button mat-icon-button (click)="onClose()" class="close-btn">
                    <mat-icon>close</mat-icon>
                </button>
            </div>

            <!-- Status Badge -->
            <div class="status-section">
                <div class="status-badge" [class.pendiente]="form.status.toLowerCase() === 'pendiente'"
                    [class.activo]="form.status.toLowerCase() === 'activo'"
                    [class.inactivo]="form.status.toLowerCase() === 'inactivo'"
                    [class.rechazado]="form.status.toLowerCase() === 'rechazado'">
                    <mat-icon>{{ currentStatus?.icon }}</mat-icon>
                    <span>{{ currentStatus?.label }}</span>
                </div>
                <span class="date-info">{{ formatDate(form.created_at) }}</span>
            </div>

            <!-- Scrollable Content -->
            <div class="card-body">
                <!-- Pending Changes Alert (Solo Admin) -->
                <div *ngIf="isAdmin && form.has_pending_changes" class="pending-changes-alert">
                    <div class="alert-content">
                        <div class="alert-icon">
                            <mat-icon>pending_actions</mat-icon>
                        </div>
                        <div class="alert-text">
                            <h4>Cambios Pendientes de Aprobación</h4>
                            <p>El agente <strong>{{ form.agent?.name }}</strong> ha propuesto modificaciones a esta
                                planilla.</p>
                            <p class="alert-date">
                                <mat-icon>schedule</mat-icon>
                                {{ formatDate(form.pending_changes_at) }}
                            </p>
                        </div>
                    </div>
                    <div class="alert-actions">
                        <button mat-icon-button class="action-btn view-btn" (click)="togglePendingChangesView()"
                            [disabled]="submitting" matTooltip="Ver cambios propuestos" matTooltipPosition="above">
                            <mat-icon>{{ viewingPendingChanges ? 'visibility_off' : 'visibility' }}</mat-icon>
                        </button>
                        <button mat-icon-button class="action-btn approve-btn" (click)="onApprovePendingChanges()"
                            [disabled]="submitting" matTooltip="Aprobar cambios" matTooltipPosition="above">
                            <mat-spinner *ngIf="submitting" diameter="20"></mat-spinner>
                            <mat-icon *ngIf="!submitting">check_circle</mat-icon>
                        </button>
                        <button mat-icon-button class="action-btn reject-btn" (click)="onShowRejectionForm()"
                            [disabled]="submitting" matTooltip="Rechazar cambios" matTooltipPosition="above">
                            <mat-icon>cancel</mat-icon>
                        </button>
                    </div>
                </div>

                <!-- Rejection Form (Solo Admin) -->
                <div *ngIf="isAdmin && showRejectionForm && form.has_pending_changes" class="rejection-form-section">
                    <div class="rejection-form-card">
                        <div class="rejection-header">
                            <mat-icon>block</mat-icon>
                            <h4>Rechazar Cambios Propuestos</h4>
                        </div>
                        <form [formGroup]="rejectionForm">
                            <mat-form-field appearance="outline" class="full-width">
                                <mat-label>Motivo del rechazo</mat-label>
                                <textarea matInput formControlName="rejection_reason" rows="4"
                                    placeholder="Explica por qué rechazas estos cambios..." maxlength="500"></textarea>
                                <mat-hint align="end">{{ rejectionForm.get('rejection_reason')?.value?.length || 0
                                    }}/500</mat-hint>
                            </mat-form-field>
                            <div class="rejection-actions">
                                <button mat-stroked-button (click)="onCancelRejection()" [disabled]="submitting">
                                    <mat-icon>close</mat-icon>
                                    Cancelar
                                </button>
                                <button mat-flat-button color="warn" (click)="onRejectPendingChanges()"
                                    [disabled]="rejectionForm.invalid || submitting">
                                    <mat-spinner *ngIf="submitting" diameter="16"></mat-spinner>
                                    <mat-icon *ngIf="!submitting">send</mat-icon>
                                    Confirmar Rechazo
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Pending Changes Comparison View -->
                <div *ngIf="isAdmin && viewingPendingChanges && form.has_pending_changes" class="pending-changes-view">
                    <div class="changes-header">
                        <mat-icon>compare_arrows</mat-icon>
                        <h3>{{ getModifiedFields().length }} {{ getModifiedFields().length === 1 ? 'Campo Modificado' :
                            'Campos Modificados' }}</h3>
                        <button mat-icon-button (click)="togglePendingChangesView()" class="close-comparison-btn">
                            <mat-icon>close</mat-icon>
                        </button>
                    </div>
                    <div class="changes-content">
                        <div class="changes-legend">
                            <div class="legend-item">
                                <span class="legend-dot current"></span>
                                <span>Actual</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-dot proposed"></span>
                                <span>Propuesto</span>
                            </div>
                        </div>
                        <div class="changes-grid">
                            <!-- Mostrar solo los campos modificados -->
                            <ng-container *ngFor="let change of getModifiedFields()">
                                <!-- Campos de personas adicionales agrupados -->
                                <ng-container *ngIf="change.category?.startsWith('person')">
                                    <!-- Este se renderiza dentro de person-changes-section más abajo -->
                                </ng-container>
                                <!-- Campos normales (no de personas) -->
                                <div class="change-item" *ngIf="!change.category?.startsWith('person')">
                                    <div class="change-label">{{ change.label }}</div>
                                    <div class="change-values">
                                        <div class="value current" *ngIf="change.field === 'gender'">
                                            {{ getFormValue(change.field) === 'M' ? 'Masculino' : 'Femenino' }}
                                        </div>
                                        <div class="value current" *ngIf="change.field === 'dob'">
                                            {{ formatDate(getFormValue(change.field)) }}
                                        </div>
                                        <div class="value current"
                                            *ngIf="change.field === 'wages' || change.field === 'subsidy' || change.field === 'final_cost' || change.field === 'poliza_amount'">
                                            {{ formatCurrency(getFormValue(change.field)) }}
                                        </div>
                                        <div class="value current"
                                            *ngIf="change.field !== 'gender' && change.field !== 'dob' && change.field !== 'wages' && change.field !== 'subsidy' && change.field !== 'final_cost' && change.field !== 'poliza_amount'">
                                            {{ getFormValue(change.field) || 'N/A' }}
                                        </div>

                                        <mat-icon class="arrow-icon">arrow_forward</mat-icon>

                                        <div class="value proposed" *ngIf="change.field === 'gender'">
                                            {{ getPendingValue(change.field) === 'M' ? 'Masculino' : 'Femenino' }}
                                        </div>
                                        <div class="value proposed" *ngIf="change.field === 'dob'">
                                            {{ formatDate(getPendingValue(change.field)) }}
                                        </div>
                                        <div class="value proposed"
                                            *ngIf="change.field === 'wages' || change.field === 'subsidy' || change.field === 'final_cost' || change.field === 'poliza_amount'">
                                            {{ formatCurrency(getPendingValue(change.field)) }}
                                        </div>
                                        <div class="value proposed"
                                            *ngIf="change.field !== 'gender' && change.field !== 'dob' && change.field !== 'wages' && change.field !== 'subsidy' && change.field !== 'final_cost' && change.field !== 'poliza_amount'">
                                            {{ getPendingValue(change.field) || 'N/A' }}
                                        </div>
                                    </div>
                                </div>
                            </ng-container>

                            <!-- Personas Adicionales Modificadas (agrupadas) -->
                            <ng-container *ngFor="let personNum of getModifiedPersons()">
                                <div class="person-changes-section">
                                    <h4 class="person-section-title">Persona {{ personNum }}</h4>
                                    <ng-container *ngFor="let change of getModifiedFields()">
                                        <div class="change-item" *ngIf="change.category === 'person' + personNum">
                                            <div class="change-label">{{ change.label }}</div>
                                            <div class="change-values">
                                                <div class="value current" *ngIf="change.field.includes('_gender')">
                                                    {{ getFormValue(change.field) === 'M' ? 'Masculino' : 'Femenino' }}
                                                </div>
                                                <div class="value current" *ngIf="change.field.includes('_dob')">
                                                    {{ formatDate(getFormValue(change.field)) }}
                                                </div>
                                                <div class="value current"
                                                    *ngIf="change.field.includes('_is_applicant')">
                                                    {{ getFormValue(change.field) ? 'Sí' : 'No' }}
                                                </div>
                                                <div class="value current"
                                                    *ngIf="!change.field.includes('_gender') && !change.field.includes('_dob') && !change.field.includes('_is_applicant')">
                                                    {{ getFormValue(change.field) || 'N/A' }}
                                                </div>

                                                <mat-icon class="arrow-icon">arrow_forward</mat-icon>

                                                <div class="value proposed" *ngIf="change.field.includes('_gender')">
                                                    {{ getPendingValue(change.field) === 'M' ? 'Masculino' : 'Femenino'
                                                    }}
                                                </div>
                                                <div class="value proposed" *ngIf="change.field.includes('_dob')">
                                                    {{ formatDate(getPendingValue(change.field)) }}
                                                </div>
                                                <div class="value proposed"
                                                    *ngIf="change.field.includes('_is_applicant')">
                                                    {{ getPendingValue(change.field) ? 'Sí' : 'No' }}
                                                </div>
                                                <div class="value proposed"
                                                    *ngIf="!change.field.includes('_gender') && !change.field.includes('_dob') && !change.field.includes('_is_applicant')">
                                                    {{ getPendingValue(change.field) || 'N/A' }}
                                                </div>
                                            </div>
                                        </div>
                                    </ng-container>
                                </div>
                            </ng-container>
                        </div>
                    </div>
                </div>

                <!-- Section 1: Información del Aplicante -->
                <div class="form-section">
                    <div class="section-header">
                        <mat-icon>person</mat-icon>
                        <h3>Información del Aplicante</h3>
                    </div>
                    <div class="section-content">
                        <div class="form-row">
                            <div class="form-field">
                                <label>Nombre Completo</label>
                                <span>{{ form.applicant_name }}</span>
                            </div>
                            <div class="form-field">
                                <label>Email</label>
                                <span>{{ form.email }}</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label>Teléfono</label>
                                <span>{{ form.phone }}</span>
                            </div>
                            <div class="form-field">
                                <label>Teléfono Alterno</label>
                                <span>{{ form.phone2 || 'N/A' }}</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label>Fecha de Nacimiento</label>
                                <span>{{ formatDate(form.dob) }}</span>
                            </div>
                            <div class="form-field">
                                <label>Género</label>
                                <span>{{ form.gender === 'M' ? 'Masculino' : 'Femenino' }}</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label>SSN</label>
                                <span>{{ form.ssn || 'N/A' }}</span>
                            </div>
                            <div class="form-field">
                                <label>Estatus Legal</label>
                                <span>{{ form.legal_status }}</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label>Número de Documento</label>
                                <span>{{ form.document_number }}</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field full-width">
                                <label>Dirección</label>
                                <span>{{ form.address }} {{ form.unit_apt ? ', ' + form.unit_apt : '' }}, {{ form.city
                                    }}, {{ form.state }} {{ form.zip_code }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Información de Empleo -->
                <div class="form-section">
                    <div class="section-header">
                        <mat-icon>work</mat-icon>
                        <h3>Información de Empleo</h3>
                    </div>
                    <div class="section-content">
                        <div class="form-row">
                            <div class="form-field">
                                <label>Tipo de Empleo</label>
                                <span>{{ form.employment_type || 'N/A' }}</span>
                            </div>
                            <div class="form-field">
                                <label>Empresa</label>
                                <span>{{ form.employment_company_name || 'N/A' }}</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label>Teléfono del Trabajo</label>
                                <span>{{ form.work_phone || 'N/A' }}</span>
                            </div>
                            <div class="form-field">
                                <label>Salario</label>
                                <span class="highlight">{{ formatCurrency(form.wages) }}</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label>Frecuencia de Pago</label>
                                <span>{{ form.wages_frequency || 'N/A' }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 3: Información de Seguro y Póliza -->
                <div class="form-section">
                    <div class="section-header">
                        <mat-icon>health_and_safety</mat-icon>
                        <h3>Información de Seguro y Póliza</h3>
                    </div>
                    <div class="section-content">
                        <div class="form-row">
                            <div class="form-field">
                                <label>Compañía de Seguro</label>
                                <span>{{ form.insurance_company || 'N/A' }}</span>
                            </div>
                            <div class="form-field">
                                <label>Plan de Seguro</label>
                                <span>{{ form.insurance_plan || 'N/A' }}</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label>Subsidio</label>
                                <span>{{ formatCurrency(form.subsidy) }}</span>
                            </div>
                            <div class="form-field">
                                <label>Costo de la Prima</label>
                                <span class="highlight">{{ formatCurrency(form.final_cost) }}</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label>Número de Póliza</label>
                                <span>{{ form.poliza_number || 'N/A' }}</span>
                            </div>
                            <div class="form-field">
                                <label>Categoría Póliza</label>
                                <span>{{ form.poliza_category || 'N/A' }}</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label>Monto Prima Dental</label>
                                <span>{{ formatCurrency(form.poliza_amount) }}</span>
                            </div>
                            <div class="form-field">
                                <label>Beneficiario</label>
                                <span>{{ form.poliza_beneficiary || 'N/A' }}</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label>Día de Pago</label>
                                <span>{{ form.poliza_payment_day || 'N/A' }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 4: Personas Adicionales -->
                <div class="form-section" *ngIf="hasAdditionalPersons()">
                    <div class="section-header">
                        <mat-icon>group</mat-icon>
                        <h3>Personas Adicionales</h3>
                    </div>
                    <div class="section-content">
                        <div *ngFor="let person of getAdditionalPersons(); let i = index" class="additional-person">
                            <div class="person-badge">Persona {{ i + 1 }}</div>
                            <div class="form-row">
                                <div class="form-field">
                                    <label>Nombre</label>
                                    <span>{{ person.name || 'N/A' }}</span>
                                </div>
                                <div class="form-field">
                                    <label>Relación</label>
                                    <span>{{ person.relation || 'N/A' }}</span>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-field">
                                    <label>Fecha de Nacimiento</label>
                                    <span>{{ formatDate(person.dob) }}</span>
                                </div>
                                <div class="form-field">
                                    <label>Género</label>
                                    <span>{{ person.gender === 'M' ? 'Masculino' : 'Femenino' }}</span>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-field">
                                    <label>SSN</label>
                                    <span>{{ person.ssn || 'N/A' }}</span>
                                </div>
                                <div class="form-field">
                                    <label>Es Aplicante</label>
                                    <span>{{ person.is_applicant ? 'Sí' : 'No' }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 5: Información del Agente -->
                <div class="form-section">
                    <div class="section-header">
                        <mat-icon>support_agent</mat-icon>
                        <h3>Información del Agente</h3>
                    </div>
                    <div class="section-content">
                        <div class="agent-card">
                            <mat-icon>account_circle</mat-icon>
                            <div class="agent-info">
                                <p class="agent-name">{{ form.agent?.name || form.agent_name }}</p>
                                <p class="agent-email">{{ form.agent?.email }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 6: Actualizar Estado (Solo Admin) -->
                <div *ngIf="isAdmin" class="form-section status-section-form">
                    <div class="section-header">
                        <mat-icon>edit_note</mat-icon>
                        <h3>Actualizar Estado</h3>
                    </div>
                    <div class="section-content">
                        <form [formGroup]="statusForm" (ngSubmit)="onSubmit()" class="status-form">
                            <div class="custom-label-group full-width">
                                <label class="custom-label-required">Nuevo Estado:</label>
                                <mat-form-field appearance="outline" class="full-width">
                                    <mat-select formControlName="status">
                                        <mat-select-trigger *ngIf="currentStatus">
                                            <div class="status-option">
                                                <mat-icon>{{ currentStatus.icon }}</mat-icon>
                                                <span>{{ currentStatus.label }}</span>
                                            </div>
                                        </mat-select-trigger>
                                        <mat-option *ngFor="let status of statuses" [value]="status.value">
                                            <div class="status-option">
                                                <mat-icon>{{ status.icon }}</mat-icon>
                                                <span>{{ status.label }}</span>
                                            </div>
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>

                            <div class="custom-label-group full-width">
                                <label class="custom-label-required">Comentario / Motivo:</label>
                                <mat-form-field appearance="outline" class="full-width">
                                    <textarea matInput formControlName="status_comment" rows="3"
                                        placeholder="Explica el motivo del cambio de estado..."
                                        maxlength="1000"></textarea>
                                    <mat-hint align="end">
                                        {{ statusForm.get('status_comment')?.value?.length || 0 }} / 1000
                                    </mat-hint>
                                </mat-form-field>
                            </div>

                            <div class="form-actions">
                                <button mat-stroked-button type="button" (click)="onClose()" [disabled]="submitting">
                                    <mat-icon>close</mat-icon>
                                    Cancelar
                                </button>
                                <button mat-flat-button color="primary" type="submit"
                                    [disabled]="statusForm.invalid || submitting">
                                    <mat-spinner *ngIf="submitting" diameter="16"></mat-spinner>
                                    <mat-icon *ngIf="!submitting">save</mat-icon>
                                    {{ submitting ? 'Guardando...' : 'Actualizar Estado' }}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Section: Historial -->
                <div class="form-section" *ngIf="form.status_comment">
                    <div class="section-header">
                        <mat-icon>history</mat-icon>
                        <h3>Último Cambio de Estado</h3>
                    </div>
                    <div class="section-content">
                        <div class="history-card">
                            <p class="history-comment">{{ form.status_comment }}</p>
                            <p class="history-date" *ngIf="form.reviewed_at">
                                <mat-icon>schedule</mat-icon>
                                {{ formatDate(form.reviewed_at) }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="card-footer">
            <div class="footer-meta">
                <span class="meta-item"><mat-icon>event</mat-icon> Creada: {{ formatDate(form.created_at) }}</span>
                <span class="meta-item"><mat-icon>update</mat-icon> Actualizada: {{ formatDate(form.updated_at)
                    }}</span>
            </div>
        </div>
    </div>
</div>