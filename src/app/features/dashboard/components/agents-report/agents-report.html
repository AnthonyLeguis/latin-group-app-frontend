<div class="agents-report-container">
    <!-- Skeleton durante carga -->
    <app-form-skeleton *ngIf="isLoading"></app-form-skeleton>

    <!-- Contenido principal -->
    <div *ngIf="!isLoading">
        <!-- Estadísticas Generales -->
        <mat-card class="stats-card" *ngIf="stats">
            <mat-card-header>
                <mat-card-title>
                    <mat-icon>bar_chart</mat-icon>
                    Estadísticas Generales
                </mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="stats-grid">
                    <div class="stat-item">
                        <mat-icon>people</mat-icon>
                        <div class="stat-info">
                            <span class="stat-value">{{ stats.total_users }}</span>
                            <span class="stat-label">Total Usuarios</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <mat-icon>admin_panel_settings</mat-icon>
                        <div class="stat-info">
                            <span class="stat-value">{{ stats.total_admins }}</span>
                            <span class="stat-label">Administradores</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <mat-icon>support_agent</mat-icon>
                        <div class="stat-info">
                            <span class="stat-value">{{ stats.total_agents }}</span>
                            <span class="stat-label">Agentes</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <mat-icon>person</mat-icon>
                        <div class="stat-info">
                            <span class="stat-value">{{ stats.total_clients }}</span>
                            <span class="stat-label">Clientes</span>
                        </div>
                    </div>
                    <div class="stat-item warn clickable group relative" (click)="openPendingForms()">
                        <mat-icon>schedule</mat-icon>
                        <div class="stat-info">
                            <span class="stat-value">{{ stats.pending_forms }}</span>
                            <span class="stat-label">Planillas Pendientes</span>
                        </div>
                        <!-- Indicador con Pulse -->
                        <div class="notification-badge" *ngIf="stats.pending_forms > 0">
                            <span class="badge-pulse"></span>
                            <span class="badge-content">{{ stats.pending_forms }}</span>
                        </div>
                        <!-- Tooltip Tailwind -->
                        <div
                            class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-1.5 bg-gray-900 text-white text-xs font-semibold rounded-md opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-50">
                            Click para ver planillas pendientes
                            <div
                                class="absolute top-full left-1/2 -translate-x-1/2 -mt-1 border-4 border-transparent border-t-gray-900">
                            </div>
                        </div>
                    </div>
                    <div class="stat-item success clickable group relative" (click)="openActiveForms()">
                        <mat-icon>check_circle</mat-icon>
                        <div class="stat-info">
                            <span class="stat-value">{{ stats.active_forms }}</span>
                            <span class="stat-label">Planillas Activas</span>
                        </div>
                        <!-- Tooltip Tailwind -->
                        <div
                            class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-1.5 bg-gray-900 text-white text-xs font-semibold rounded-md opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-50">
                            Click para ver planillas activas
                            <div
                                class="absolute top-full left-1/2 -translate-x-1/2 -mt-1 border-4 border-transparent border-t-gray-900">
                            </div>
                        </div>
                    </div>
                </div>
            </mat-card-content>
        </mat-card>

        <!-- Reporte de Agentes -->
        <mat-card class="agents-card">
            <mat-card-header>
                <mat-card-title>
                    <mat-icon>support_agent</mat-icon>
                    Reporte de Agentes
                </mat-card-title>
                <mat-card-subtitle>
                    {{ totalAgents }} agentes con {{ totalClients }} clientes en total
                </mat-card-subtitle>
            </mat-card-header>

            <mat-card-content>
                <!-- Buscador y Filtros de Estado -->
                <div class="filters-row">
                    <!-- Buscador -->
                    <mat-form-field appearance="outline" class="search-field">
                        <mat-label>Buscar agente o cliente</mat-label>
                        <input matInput [(ngModel)]="searchTerm" (input)="onSearch()"
                            placeholder="Escribe un nombre o email...">
                        <mat-icon matPrefix>search</mat-icon>
                        <button mat-icon-button matSuffix *ngIf="searchTerm" (click)="clearSearch()" type="button">
                            <mat-icon>close</mat-icon>
                        </button>
                        <mat-hint>Filtra por nombre o email de agente o cliente</mat-hint>
                    </mat-form-field>

                    <!-- Píldoras de Filtro por Estado -->
                    <div class="status-filters">
                        <button mat-stroked-button class="status-chip pendiente"
                            [class.active]="selectedStatus === 'pendiente'" (click)="filterByStatus('pendiente')">
                            <mat-icon>schedule</mat-icon>
                            <span>Pendiente</span>
                        </button>
                        <button mat-stroked-button class="status-chip activo"
                            [class.active]="selectedStatus === 'activo'" (click)="filterByStatus('activo')">
                            <mat-icon>check_circle</mat-icon>
                            <span>Activo</span>
                        </button>
                        <button mat-stroked-button class="status-chip rechazado"
                            [class.active]="selectedStatus === 'rechazado'" (click)="filterByStatus('rechazado')">
                            <mat-icon>error</mat-icon>
                            <span>Rechazado</span>
                        </button>
                        <button mat-stroked-button class="status-chip inactivo"
                            [class.active]="selectedStatus === 'inactivo'" (click)="filterByStatus('inactivo')">
                            <mat-icon>cancel</mat-icon>
                            <span>Inactivo</span>
                        </button>
                    </div>
                </div>

                <!-- Lista de Agentes con Expansión -->
                <mat-accordion class="agents-accordion">
                    <mat-expansion-panel *ngFor="let agent of filteredAgents" class="agent-panel">
                        <mat-expansion-panel-header>
                            <mat-panel-title>
                                <div class="agent-header">
                                    <mat-icon class="agent-icon">support_agent</mat-icon>
                                    <div class="agent-info">
                                        <span class="agent-name">{{ agent.name }}</span>
                                        <span class="agent-email">{{ agent.email }}</span>
                                    </div>
                                </div>
                            </mat-panel-title>
                            <mat-panel-description>
                                <div class="badges-container">
                                    <mat-chip class="clients-chip">
                                        <mat-icon>person</mat-icon>
                                        {{ agent.clients_count }} {{ agent.clients_count === 1 ? 'cliente' : 'clientes'
                                        }}
                                    </mat-chip>

                                    <!-- Notificación de cambios pendientes -->
                                    <mat-chip *ngIf="agent.pending_changes_count && agent.pending_changes_count > 0"
                                        class="pending-changes-chip">
                                        <mat-icon>pending_actions</mat-icon>
                                        <span>{{ agent.pending_changes_count }} pendiente{{ agent.pending_changes_count
                                            === 1 ? '' : 's' }}</span>
                                    </mat-chip>
                                </div>
                            </mat-panel-description>
                        </mat-expansion-panel-header>

                        <!-- Clientes del Agente -->
                        <div class="clients-list"
                            *ngIf="agent.created_users && agent.created_users.length > 0; else noClients">
                            <h4 class="clients-title">Clientes Asignados</h4>
                            <div class="client-card" *ngFor="let client of agent.created_users">
                                <div class="client-header">
                                    <mat-icon class="client-icon">person</mat-icon>
                                    <div class="client-info">
                                        <span class="client-name">{{ client.name }}</span>
                                        <span class="client-email">{{ client.email }}</span>
                                        <!-- Indicador de creación por admin -->
                                        <span class="created-by-admin"
                                            *ngIf="client.created_by_admin && client.created_by_admin.name">
                                            <mat-icon class="admin-icon">admin_panel_settings</mat-icon>
                                            Creado por: {{ client.created_by_admin.name }}
                                        </span>
                                    </div>
                                </div>

                                <!-- Planillas del Cliente -->
                                <div class="forms-section"
                                    *ngIf="client.application_forms_as_client && client.application_forms_as_client.length > 0">
                                    <h5 class="forms-title">Planillas de Aplicación</h5>
                                    <div class="forms-list">
                                        <div class="form-item clickable group relative"
                                            [class.has-pending-changes]="form.has_pending_changes"
                                            *ngFor="let form of client.application_forms_as_client"
                                            (click)="openFormDetail(form.id)">
                                            <mat-icon [class]="'form-icon ' + form.status">
                                                {{ getStatusIcon(form.status) }}
                                            </mat-icon>
                                            <div class="form-details">
                                                <span class="form-id">Planilla #{{ form.id }}</span>
                                                <span class="form-date">{{ form.created_at | date: 'dd/MM/yyyy'
                                                    }}</span>
                                            </div>
                                            <mat-chip [class]="'status-chip ' + form.status">
                                                {{ form.status }}
                                            </mat-chip>

                                            <!-- Indicador de cambios pendientes -->
                                            <div *ngIf="form.has_pending_changes" class="pending-indicator">
                                                <mat-icon class="pulse-icon-small">edit_note</mat-icon>
                                                <span>Cambios pendientes</span>
                                            </div>

                                            <!-- Tooltip Tailwind -->
                                            <div
                                                class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-1.5 bg-gray-900 text-white text-xs font-semibold rounded-md opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-50">
                                                {{ form.has_pending_changes ? 'Click para revisar y aprobar cambios' :
                                                'Click para ver detalles y modificar estado' }}
                                                <div
                                                    class="absolute top-full left-1/2 -translate-x-1/2 -mt-1 border-4 border-transparent border-t-gray-900">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Sin planillas -->
                                <div class="no-forms"
                                    *ngIf="!client.application_forms_as_client || client.application_forms_as_client.length === 0">
                                    <mat-icon>info</mat-icon>
                                    <span>Sin planillas de aplicación</span>
                                </div>
                            </div>
                        </div>

                        <!-- No hay clientes -->
                        <ng-template #noClients>
                            <div class="no-clients">
                                <mat-icon>info</mat-icon>
                                <p>Este agente aún no tiene clientes asignados</p>
                            </div>
                        </ng-template>
                    </mat-expansion-panel>
                </mat-accordion>

                <!-- Sin agentes -->
                <div class="no-data" *ngIf="filteredAgents.length === 0">
                    <mat-icon>inbox</mat-icon>
                    <h3>No hay agentes {{ searchTerm ? 'que coincidan con la búsqueda' : 'registrados' }}</h3>
                    <p>{{ searchTerm ? 'Intenta con otro término de búsqueda' : 'Aún no se han creado agentes en el
                        sistema' }}</p>
                </div>
            </mat-card-content>
        </mat-card>
    </div>
</div>